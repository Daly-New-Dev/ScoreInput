<!DOCTYPE html>
<html lang="km">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <!-- PWA Meta Tags -->
  <meta name="theme-color" content="#007BFF"/>
  <link rel="manifest" href="/manifest.json">
  <link rel="apple-touch-icon" href="/icons/icon-192x192.png">

  <title>ប្រព័ន្ធបញ្ចូលពិន្ទុសិស្សសម្រាប់គ្រូបន្ទុកថ្នាក់</title>
  <link href="https://fonts.googleapis.com/css2?family=Khmer+OS+Battambang&family=Khmer+OS+Muol+Light&display=swap" rel="stylesheet">
  <style>
    body{margin:0;font-family:'Khmer OS Battambang',sans-serif;background:#f4f6f8}
    
    /* MODIFIED HEADER STYLES */
    header{
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 20px;
      background-color:#007BFF;
      color:#fff;
    }
    /* NEW: Logo styles */
    .header-logo {
      height: 60px; /* Default height */
      width: auto;
      flex-shrink: 0;
    }

    /* NEW: Specific logo IDs */
    #school-logo {
      height: 100px; /* User request */
      /* Removed margin-right to allow margin-left on text block to be exact */
    }
    #moeys-logo {
      height: 100px; /* User request */
      margin-left: 10px; /* Default spacing */
    }

    /* NEW: Text container */
    .header-text {
      text-align: center;
      flex-grow: 1;
      padding: 0 15px;
    }
    /* User request: 100px spacing from school name */
    #school-logo + .header-text {
      margin-left: 100px;
    }

    header h1{font-family:'Khmer OS Muol Light';font-size:28px;margin:0}
    header h2{font-size:20px;margin:5px 0 0}
    /* END OF HEADER MODIFICATIONS */

    .container{display:flex;padding:20px;gap:20px}.form-panel{width:35%;background:#fff;padding:20px;box-shadow:2px 0 5px rgba(0,0,0,.1);position:sticky;top:20px;align-self:flex-start;border-radius:5px;font-family:'Khmer OS Battambang',sans-serif}.table-panel{width:65%;background:#fff;padding:20px;box-shadow:2px 0 5px rgba(0,0,0,.1);border-radius:5px;overflow-x:auto}label{font-weight:700;display:block;margin-top:10px;font-family:'Khmer OS Battambang',sans-serif}select,input[type=text],input[type=number]{width:100%;padding:8px;font-size:16px;border-radius:5px;border:1px solid #ccc;box-sizing:border-box;height:40px;font-family:'Khmer OS Battambang',sans-serif}.row{display:flex;gap:10px;align-items:flex-end}.row>div{flex:1}button{background-color:#007BFF;border:none;color:#fff;padding:8px;font-size:16px;border-radius:5px;cursor:pointer;font-family:'Khmer OS Battambang',sans-serif;width:100%;margin-top:15px;height:40px;box-sizing:border-box}button:hover{background-color:#0056b3}.export-section{margin-top:20px;border-top:1px solid #ccc;padding-top:15px}.export-section .row button{margin-top:0}table{width:100%;border-collapse:collapse;font-family:'Khmer OS Battambang'}th,td{border:1px solid #ccc;padding:10px 5px;text-align:center;font-size:15px}th{background:#007BFF;color:#fff;position:sticky;top:-1px}#message{margin-top:10px;font-weight:700;color:green;height:20px}
    
    @media (max-width:768px){
      .container{flex-direction:column;padding:10px;gap:15px}.form-panel,.table-panel{width:100%;box-sizing:border-box;position:static}.row{flex-direction:column;gap:0;align-items:stretch}.row>div{margin-bottom:10px}.export-section .row{flex-direction:row}
      
      /* MODIFIED: Responsive header styles */
      header {
        padding: 10px;
      }
      .header-logo {
        height: 40px; /* Smaller logo for mobile */
      }
      /* Responsive overrides for IDs */
      #school-logo, #moeys-logo {
         height: 40px;
      }
      #school-logo + .header-text {
         margin-left: 10px; /* Reduce spacing on mobile */
      }

      .header-text {
        padding: 0 5px; /* Less padding for mobile */
      }
      header h1{
        font-size: 16px; /* Adjusted font size */
      }
      header h2{
        font-size: 12px; /* Adjusted font size */
      }
      /* END OF RESPONSIVE MODIFICATIONS */

      th,td{font-size:14px;padding:8px 4px}}
  </style>
</head>
<body>
  <!-- MODIFIED HEADER SECTION -->
  <header>
    <img src="/icons/school_logo.PNG" alt="School Logo" class="header-logo" id="school-logo"
         onerror="this.style.display='none'"> <!-- Hides if logo fails to load -->
    
    <div class="header-text">
      <h1>វិទ្យាល័យ ហ៊ុន សែន ក្រាំងស្រម៉</h1>
      <h2>ប្រព័ន្ធបញ្ចូលពិន្ទុសិស្សសម្រាប់គ្រូបន្ទុកថ្នាក់</h2>
    </div>
    
    <img src="/icons/moeys_logo.PNG" alt="MoEYS Logo" class="header-logo" id="moeys-logo"
         onerror="this.style.display='none'"> <!-- Hides if logo fails to load -->
  </header>
  <!-- END OF MODIFIED HEADER -->

  <div class="container">
    <div class="form-panel">
      <!-- Main form content is now in a container to be hidden on error -->
      <div id="main-form-content">
        <div class="row">
          <div>
            <label>ជ្រើសរើសថ្នាក់:</label>
            <select id="classSelect"><option value="">កំពុងទាញយកទិន្នន័យ...</option></select>
          </div>
          <div>
            <label>ជ្រើសរើសមុខវិជ្ជា:</label>
            <select id="subjectSelect"><option value="">កំពុងទាញយកទិន្នន័យ...</option></select>
          </div>
        </div>

        <div class="row">
          <!-- MODIFIED: Replaced month input with period select -->
          <div>
            <label>ជ្រើសរើសវគ្គ:</label>
            <select id="periodSelect"><option value="">កំពុងទាញយកទិន្នន័យ...</option></select>
          </div>
          <div><label>ឈ្មោះគ្រូ:</label><input type="text" id="teacherInput" placeholder="ឧ. ទឿន ដាលី"></div>
        </div>

        <button id="submitBtn">បញ្ចូលពិន្ទុ</button>
        <div id="message"></div>

        <div class="export-section">
          <label>ទាញយកពិន្ទុជា Excel:</label>
          <!-- MODIFIED: Added period select for export -->
          <div class="row">
            <div>
              <label>ថ្នាក់:</label>
              <select id="exportClassSelect"><option value="">កំពុងទាញយកទិន្នន័យ...</option></select>
            </div>
            <div>
              <label>វគ្គ:</label>
              <select id="exportPeriodSelect"><option value="">កំពុងទាញយកទិន្នន័យ...</option></select>
            </div>
          </div>
          <button id="exportBtn" style="width:100%; margin-top: 10px;">ទាញយក Excel</button>
        </div>
      </div>
      
      <!-- New error panel with a retry button -->
      <div id="error-panel" style="display: none; text-align: center; padding: 20px; background-color: #ffebee; border: 1px solid #f44336; border-radius: 5px;">
        <p style="color: #d32f2f; font-weight: bold; font-size: 18px;">ទាញយកទិន្នន័យមិនត្រឹមត្រូវ</p>
        <p style="color: #555; margin: 10px 0 15px 0;">សូមពិនិត្យការតភ្ជាប់អ៊ីនធឺណិតរបស់អ្នក រួចព្យាយាមម្តងទៀត។</p>
        <button id="retryBtn" style="background-color: #007BFF; color: white; width: auto; padding: 10px 20px; margin-top: 0;">ព្យាយាមម្តងទៀត</button>
      </div>

    </div>

    <div class="table-panel">
      <table>
        <thead>
          <tr><th>ល.រ</th><th>ឈ្មោះសិស្ស</th><th>ភេទ</th><th>ថ្នាក់</th><th>ពិន្ទុ</th></tr>
        </thead>
        <tbody id="studentTableBody"></tbody>
      </table>
    </div>
  </div>

  <script>
    const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxcwGOHAxLBT8PBZIcXEOkoj4SlFomGDqw19wqn-WB_e0IuAWDFW9KePY2IDJLzgf9Usw/exec';
    let students = [];

    const mainFormContent = document.getElementById('main-form-content');
    const errorPanel = document.getElementById('error-panel');
    const retryBtn = document.getElementById('retryBtn');

    // Helper function to show a temporary message
    function showMessage(text, isSuccess) {
      const messageDiv = document.getElementById("message");
      messageDiv.innerText = text;
      messageDiv.style.color = isSuccess ? 'green' : 'red';
      setTimeout(() => messageDiv.innerText = "", 5000);
    }

    // Helper function to handle fetch errors and JSON parsing
    async function fetchJson(url, options) {
      let response;
      try {
        response = await fetch(url, options);
      } catch (networkError) {
        console.error("Network error:", networkError);
        throw new Error(`Network request failed: ${networkError.message}`);
      }

      if (!response.ok) {
        console.error("Network response was not OK:", response.status, response.statusText);
        throw new Error(`Server error: ${response.status} ${response.statusText}`);
      }

      const text = await response.text();
      try {
        const data = JSON.parse(text);
        if (data.error) {
          throw new Error(data.error);
        }
        return data;
      } catch (parseError) {
        console.error("Failed to parse JSON response:", parseError);
        console.log("Raw response from server:", text);
        throw new Error("Invalid response from server. Check console.");
      }
    }

    async function loadDropdowns() {
      mainFormContent.style.display = 'block';
      errorPanel.style.display = 'none';
      
      // Set all dropdowns to loading state
      const loadingOption = '<option value="">កំពុងទាញយកទិន្នន័យ...</option>';
      document.getElementById('classSelect').innerHTML = loadingOption;
      document.getElementById('subjectSelect').innerHTML = loadingOption;
      document.getElementById('periodSelect').innerHTML = loadingOption; // New
      document.getElementById('exportClassSelect').innerHTML = loadingOption;
      document.getElementById('exportPeriodSelect').innerHTML = loadingOption; // New

      try {
        // Fetch all dropdown data in parallel
        const [classes, subjects, periods] = await Promise.all([
          fetchJson(`${SCRIPT_URL}?action=getClassList`),
          fetchJson(`${SCRIPT_URL}?action=getSubjectList`),
          fetchJson(`${SCRIPT_URL}?action=getPeriodList`) // New
        ]);

        // Populate Class dropdowns
        const classSelect = document.getElementById("classSelect");
        const exportClassSelect = document.getElementById("exportClassSelect");
        classSelect.innerHTML = '<option value="">ជ្រើសរើសថ្នាក់</option>';
        exportClassSelect.innerHTML = '<option value="">ជ្រើសរើសថ្នាក់</option>';
        if (Array.isArray(classes)) {
          classes.forEach(cls => {
            classSelect.innerHTML += `<option value="${cls}">${cls}</option>`;
            exportClassSelect.innerHTML += `<option value="${cls}">${cls}</option>`;
          });
        }

        // Populate Subject dropdown
        const subjectSelect = document.getElementById("subjectSelect");
        subjectSelect.innerHTML = '<option value="">ជ្រើសរើសមុខវិជ្ជា</option>';
        if (Array.isArray(subjects)) {
          subjects.forEach(sub => {
            subjectSelect.innerHTML += `<option value="${sub}">${sub}</option>`;
          });
        }

        // NEW: Populate Period dropdowns
        const periodSelect = document.getElementById("periodSelect");
        const exportPeriodSelect = document.getElementById("exportPeriodSelect");
        periodSelect.innerHTML = '<option value="">ជ្រើសរើសវគ្គ</option>';
        exportPeriodSelect.innerHTML = '<option value="">ជ្រើសរើសវគ្គ</option>';
        if (Array.isArray(periods)) {
          periods.forEach(period => {
            // period is {name: "វិច្ឆកា", value: "Nov2025"}
            periodSelect.innerHTML += `<option value="${period.value}">${period.name}</option>`;
            exportPeriodSelect.innerHTML += `<option value="${period.value}">${period.name}</option>`;
          });
        }

      } catch (error) {
        console.error("Error loading dropdowns:", error);
        mainFormContent.style.display = 'none';
        errorPanel.style.display = 'block';
      }
    }

    async function loadStudents() {
      const selectedClass = document.getElementById("classSelect").value;
      const tableBody = document.getElementById("studentTableBody");
      if (!selectedClass) {
        tableBody.innerHTML = "";
        students = []; // Clear student array
        return;
      }
      tableBody.innerHTML = '<tr><td colspan="5">កំពុងទាញយកទិន្នន័យសិស្ស...</td></tr>';
      try {
        // This gets the master list of students for the class
        students = await fetchJson(`${SCRIPT_URL}?action=getStudentsByClass&class=${selectedClass}`);
        renderTable();
      } catch (error) {
        console.error("Error loading students:", error);
        tableBody.innerHTML = `<tr><td colspan="5" style="color:red;">${error.message}</td></tr>`;
      }
    }

    function renderTable() {
      const tableBody = document.getElementById("studentTableBody");
      let html = "";
      if (students.length === 0) {
        html = '<tr><td colspan="5">មិនមានទិន្នន័យសិស្សក្នុងថ្នាក់នេះទេ។</td></tr>';
      } else {
        students.forEach((student, index) => {
          html += `
            <tr>
              <td>${index + 1}</td>
              <td style="text-align: left; padding-left: 10px;">${student.name}</td>
              <td>${student.gender}</td>
              <td>${student.class}</td>
              <td><input type="number" class="score-input" data-row="${student.rowIndex}" style="width:60px;"></td>
            </tr>`;
        });
      }
      tableBody.innerHTML = html;
    }

    function handleTableKeydown(e) {
      if (!e.target.classList.contains('score-input')) return;
      if (e.key === "Enter" || e.key === "Tab") {
        e.preventDefault();
        const inputs = [...document.querySelectorAll(".score-input")];
        const idx = inputs.indexOf(e.target);
        if (idx < inputs.length - 1) {
          inputs[idx + 1].focus();
        } else if (e.key === "Enter") {
          document.getElementById("submitBtn").focus();
        }
      }
    }

    function handleTablePaste(e) {
      if (!e.target.classList.contains('score-input')) return;
      e.preventDefault();
      const pastedData = (e.clipboardData || window.clipboardData).getData('text');
      if (!pastedData) return;

      const scores = pastedData.trim().split(/\r?\n/);
      const allInputs = [...document.querySelectorAll(".score-input")];
      const startIndex = allInputs.indexOf(e.target);

      scores.forEach((score, index) => {
        const targetIndex = startIndex + index;
        if (targetIndex < allInputs.length && score.trim() !== "") {
          allInputs[targetIndex].value = score.trim();
        }
      });
      
      const nextFocusIndex = startIndex + scores.length;
      if (nextFocusIndex < allInputs.length) {
          allInputs[nextFocusIndex].focus();
      } else if (allInputs.length > 0) {
          allInputs[allInputs.length - 1].focus();
      }
    }

    async function submitScores() {
      const teacher = document.getElementById("teacherInput").value.trim();
      const period = document.getElementById("periodSelect").value; // MODIFIED
      const subject = document.getElementById("subjectSelect").value;
      const classVal = document.getElementById("classSelect").value;
      
      if (!teacher || !period || !subject || !classVal) {
        alert("សូមបំពេញព័ត៌មានទាំងអស់ (គ្រូ, វគ្គ, មុខវិជ្ជា, ថ្នាក់)");
        return;
      }

      const scores = [];
      document.querySelectorAll(".score-input").forEach(input => {
        if (input.value.trim() !== "") {
          scores.push({ rowIndex: parseInt(input.dataset.row), score: input.value.trim() });
        }
      });
      
      if(scores.length === 0) {
        alert("សូមបញ្ចូលពិន្ទុយ៉ាងតិចមួយ។");
        return;
      }

      const submitBtn = document.getElementById("submitBtn");
      submitBtn.disabled = true;
      submitBtn.textContent = "កំពុងរក្សាទុក...";

      try {
        // MODIFIED: Send 'period' instead of 'month'
        const payload = { teacher, period, subject, scores };
        const result = await fetchJson(SCRIPT_URL, {
          method: 'POST',
          body: JSON.stringify({ action: 'submitScores', payload }),
          headers: { 'Content-Type': 'text/plain;charset=utf-8' } // Keep as text/plain if GAS requires
        });
        
        showMessage(result.message, result.status === 'success');
        if(result.status === 'success') {
          // Clear scores after successful submission
          document.querySelectorAll(".score-input").forEach(input => input.value = "");
        }

      } catch (error) {
        console.error("Error submitting scores:", error);
        showMessage(`មានបញ្ហា៖ ${error.message}`, false);
      } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = "បញ្ចូលពិន្ទុ";
      }
    }

    function exportExcel() {
      // MODIFIED: Get both class and period
      const exportClass = document.getElementById("exportClassSelect").value;
      const exportPeriod = document.getElementById("exportPeriodSelect").value;

      if (!exportClass || !exportPeriod) {
        alert("សូមជ្រើសរើសថ្នាក់ និង វគ្គ សម្រាប់ទាញយក");
        return;
      }
      
      const exportBtn = document.getElementById("exportBtn");
      exportBtn.disabled = true;
      exportBtn.textContent = "កំពុងទាញយក...";

      // MODIFIED: Add period to the export URL
      const exportUrl = `${SCRIPT_URL}?action=exportClassToExcel&class=${encodeURIComponent(exportClass)}&period=${encodeURIComponent(exportPeriod)}`;
      
      window.open(exportUrl, '_blank');
      
      setTimeout(() => {
        exportBtn.disabled = false;
        exportBtn.textContent = "ទាញយក Excel";
      }, 3000);
    }

    // --- Event Listeners ---
    document.getElementById("classSelect").addEventListener("change", loadStudents);
    document.getElementById("submitBtn").addEventListener("click", submitScores);
    document.getElementById("exportBtn").addEventListener("click", exportExcel);
    retryBtn.addEventListener('click', loadDropdowns);
    
    document.getElementById("studentTableBody").addEventListener("keydown", handleTableKeydown);
    document.getElementById("studentTableBody").addEventListener("paste", handleTablePaste);

    window.onload = loadDropdowns;

    // --- Service Worker ---
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('/service-worker.js').then(registration => {
          console.log('ServiceWorker registration successful with scope: ', registration.scope);
        }, err => {
          console.log('ServiceWorker registration failed: ', err);
        });
      });
    }
  </script>
</body>
</html>